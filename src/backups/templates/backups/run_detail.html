{% extends "base.html" %}
{% load humanize %}

{% block title %}Run #{{ run.id }} - Echoport{% endblock %}

{% block content %}
<div class="run-detail">
    <nav class="breadcrumb">
        <a href="{% url 'backups:dashboard' %}">Dashboard</a> &raquo;
        <a href="{% url 'backups:target_detail' target.id %}">{{ target.name }}</a> &raquo;
        <span>Run #{{ run.id }}</span>
    </nav>

    <div class="run-header">
        <h2>Backup Run #{{ run.id }}</h2>
        <span class="status-badge status-{{ run.status }}">{{ run.get_status_display }}</span>
    </div>

    <div class="run-summary">
        <dl>
            <dt>Target</dt>
            <dd><a href="{% url 'backups:target_detail' target.id %}">{{ target.name }}</a></dd>

            <dt>Trigger</dt>
            <dd>{{ run.get_trigger_display }}{% if run.triggered_by %} ({{ run.triggered_by }}){% endif %}</dd>

            <dt>Started</dt>
            <dd>{{ run.started_at|date:"Y-m-d H:i:s" }}</dd>

            {% if run.finished_at %}
            <dt>Finished</dt>
            <dd>{{ run.finished_at|date:"Y-m-d H:i:s" }}</dd>

            <dt>Duration</dt>
            <dd>{{ run.duration_seconds|floatformat:1 }} seconds</dd>
            {% endif %}

            {% if run.fastdeploy_deployment_id %}
            <dt>FastDeploy Deployment</dt>
            <dd>#{{ run.fastdeploy_deployment_id }}</dd>
            {% endif %}
        </dl>
    </div>

    {% if run.status == 'success' %}
    <div class="run-result">
        <h3>Backup Result</h3>
        <dl>
            <dt>Storage Location</dt>
            <dd><code>{{ run.storage_bucket }}/{{ run.storage_key }}</code></dd>

            <dt>Size</dt>
            <dd>{{ run.size_bytes|filesizeformat }} ({{ run.size_bytes|intcomma }} bytes)</dd>

            {% if run.file_count %}
            <dt>Files</dt>
            <dd>{{ run.file_count }} file{{ run.file_count|pluralize }}</dd>
            {% endif %}

            {% if run.checksum_sha256 %}
            <dt>SHA256 Checksum</dt>
            <dd><code class="checksum">{{ run.checksum_sha256 }}</code></dd>
            {% endif %}
        </dl>
    </div>
    {% endif %}

    {% if run.error_message %}
    <div class="run-error">
        <h3>Error</h3>
        <pre class="error-message">{{ run.error_message }}</pre>
    </div>
    {% endif %}

    {% if run.logs %}
    <div class="run-logs">
        <h3>Logs</h3>
        <pre class="log-output">{{ run.logs }}</pre>
    </div>
    {% endif %}

    {% if run.status == 'success' and user.is_staff %}
    <div class="restore-section">
        <h3>Restore from this Backup</h3>
        <div class="restore-warning">
            <strong>Warning:</strong> Restoring will overwrite the current database and files for {{ target.name }}.
            {% if target.service_name %}The service <code>{{ target.service_name }}</code> will be stopped during restore and restarted afterward.{% endif %}
            This action cannot be undone.
        </div>

        {% if not run.checksum_sha256 %}
        <p class="restore-blocked">This backup has no checksum and cannot be safely restored.</p>
        {% elif active_backup %}
        <p class="restore-blocked">A backup is currently running. Please wait for it to complete before restoring.</p>
        {% elif active_restore %}
        <p class="restore-blocked">A restore is currently running. <a href="{% url 'backups:restore_detail' active_restore.id %}">View progress</a></p>
        {% else %}
        <button type="button" class="btn btn-danger" onclick="document.getElementById('restore-dialog').showModal()">
            Restore Now
        </button>

        <dialog id="restore-dialog" class="confirm-dialog">
            <h4>Confirm Restore</h4>
            <p>Are you sure you want to restore from this backup?</p>
            <p>This will:</p>
            <ul>
                {% if target.service_name %}<li>Stop the <code>{{ target.service_name }}</code> service</li>{% endif %}
                <li>Overwrite the current database{% if target.backup_files %} and {{ target.backup_files|length }} file(s){% endif %}</li>
                {% if target.service_name %}<li>Restart the <code>{{ target.service_name }}</code> service</li>{% endif %}
            </ul>
            <div class="dialog-actions">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('restore-dialog').close()">
                    Cancel
                </button>
                <form method="post" action="{% url 'backups:trigger_restore' run.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        Yes, Restore Now
                    </button>
                </form>
            </div>
        </dialog>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
